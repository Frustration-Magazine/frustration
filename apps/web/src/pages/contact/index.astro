---
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Textarea } from "@/components/ui/textarea";
import ContactSubjectSelect from "@/pages/contact/_components/ContactSubjectSelect";
import PageLayout from "@/layout/PageLayout/PageLayout.astro";
import { cn } from "@/lib/utils";
import { Resend } from "resend";

export const prerender = false;

const resend = new Resend(process.env.RESEND_API_KEY);

const INVALID_CAPTCHA_STATUS = "invalid-captcha";
const NO_SUBJECT_STATUS = "no-subject";
const ERROR_STATUS = "error";
const SUCCESS_STATUS = "success";

let status = null;
let subject = "";
let email = "";
let message = "";

if (Astro.request.method === "POST") {
  if (!process.env.RESEND_API_KEY) {
    console.warn("🔎 Missing api key to add subscriber");
    status = ERROR_STATUS;
  }

  if (!process.env.HCAPTCHA_SITE_KEY) {
    console.warn("🔎 Missing hcaptcha site key");
    status = ERROR_STATUS;
  }

  const dateOptions = {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false,
    timeZone: "Europe/Paris",
  };
  const now = new Date();
  const formattedDate = now.toLocaleString("fr-FR", dateOptions as Intl.DateTimeFormatOptions);

  try {
    const data = await Astro.request.formData();
    const hcaptchaResponse = data.get("h-captcha-response");
    subject = data.get("subject")?.toString() ?? "";
    email = data.get("email")?.toString() ?? "";
    message = data.get("message")?.toString() ?? "";

    if (!hcaptchaResponse) {
      status = INVALID_CAPTCHA_STATUS;
    } else if (!subject) {
      status = NO_SUBJECT_STATUS;
    } else {
      await resend.emails.send({
        from: import.meta.env.MAIL_FROM,
        to: [import.meta.env.MAIL_FROM],
        subject: `Formulaire de contact - ${subject} - ${email}`,
        html: `
        <h2>Sujet : ${subject}</h4>
        <h3>Demande envoyée par : ${email} le ${formattedDate}</h3>
        <br />
        <p>${message}</p>
        `,
      });

      status = SUCCESS_STATUS;
      subject = "";
      email = "";
      message = "";
    }
  } catch (error) {
    if (error instanceof Error) console.error(error.message);
    status = ERROR_STATUS;
  }
}
---

<PageLayout title="Nous contacter">
  <article slot="content">
    <!-- 🅰️ Titles -->
    <h2
      class={cn(
        "font-parisienne text-balance text-center font-bold",
        "mb-6 text-4xl",
        "sm:mb-6 sm:text-5xl",
        "md:zs-8 md:mb-8 md:text-5xl",
        "lg:mb-10 lg:text-8xl",
      )}
    >
      Chère Frustration,
    </h2>
    <div class={cn("font-open-sans space-y-3 text-center", "space-y-1 text-base", "sm:space-y-2 sm:text-xl")}>
      <p>Une réaction à chaud ?</p>
      <p>Une question qui vous turlupine ?</p>
      <p>Une idée d'article ou d'enquête ?</p>
    </div>
    <p class={cn("font-open-sans my-10 text-center font-bold", "text-2xl", "sm:text-3xl")}>
      N'hésitez pas à nous écrire !
    </p>
    <form
      id="contact"
      method="POST"
      class="font-open-sans flex flex-col gap-4"
    >
      <ContactSubjectSelect
        portalUrl={import.meta.env.STRIPE_PORTAL_CLIENT}
        client:load
      />
      <Input
        type="email"
        placeholder="Votre email de contact"
        name="email"
        id="email"
        defaultValue={email}
        required
      />
      <Textarea
        name="message"
        placeholder="Votre message"
        rows={10}
        minLength={10}
        maxLength={5000}
        id="message"
        defaultValue={message}
        required
      />

      {
        status &&
          (status === ERROR_STATUS ? (
            <p class="rounded bg-red-200 p-4 text-center text-red-700">
              😔 Une erreur est survenue. Veuillez réessayer ou nous contacter directement à l'adresse{" "}
              <a
                href={`mailto:${import.meta.env.MAIL_FROM}`}
                class="font-bold underline"
              >
                {import.meta.env.MAIL_FROM}
              </a>{" "}
              si le problème persiste.
            </p>
          ) : status === INVALID_CAPTCHA_STATUS ? (
            <p class="rounded bg-orange-200 p-4 text-center text-orange-700">👇 Veuillez valider le captcha.</p>
          ) : status === NO_SUBJECT_STATUS ? (
            <p class="rounded bg-orange-200 p-4 text-center text-orange-700">👆 Veuillez sélectionner un sujet.</p>
          ) : status === SUCCESS_STATUS ? (
            <p class="rounded bg-green-200 p-4 text-center text-green-700">
              🙂 Votre message a bien été envoyé !<br />
              Nous tâcherons de vous répondre dans les plus brefs délais.
            </p>
          ) : null)
      }

      <div
        class="h-captcha mx-auto"
        data-sitekey={process.env.HCAPTCHA_SITE_KEY}
      >
      </div>
      <Button
        type="submit"
        className="font-bakbak hover:text-primary text-primary mx-auto w-fit bg-black px-8 py-6 text-xl hover:bg-black"
        >Envoyer</Button
      >
    </form>
  </article>
</PageLayout>

<script
  src="https://js.hcaptcha.com/1/api.js"
  async
  defer
  is:inline
></script>
