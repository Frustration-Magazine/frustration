---
// 🧱 Components
import CheckoutFormWrapper from "./_components/CheckoutFormWrapper";
import ProgressBar from "./_components/ProgressBar";
import TitlePullUp from "./_components/TitlePullUp";

// 🖼️ Layout
import BaseLayout from "@web/layout/BaseLayout/BaseLayout.astro";
import PageLayout from "@web/layout/PageLayout/PageLayout.astro";

// 🔧 Libs
import { stripe } from "@/data-access/stripe";

export const prerender = false;
Astro.response.headers.set('Cache-Control', 's-maxage=3600, stale-while-revalidate');

// Compute percent in prohress for campaign
 let transactions: any[] = [];
  let has_more;
  let next_page;
  do {
    try {
      const resTransactions = (await stripe.charges.search({
        query: `metadata['campaign']:'dons-fin-2024' AND created>${(new Date("2024-11-07").getTime()) / 1000}`,
        limit: 100,
        ...(next_page ? { page: next_page } : {}),
      })) as any;
      next_page = resTransactions.next_page;
      if (has_more) next_page = resTransactions.next_page;
      transactions = [...transactions, ...resTransactions.data];
    } catch (e) {
      console.error("Error while fetching transactions for campaign", e);
    }
  } while (has_more);
  const total = transactions.filter(transaction => !transaction.invoice).reduce((acc, cv) => acc + (cv.amount/100) , 0)
  const MIN_VALUE = 5
  const progressInPercent = Math.max((Math.floor(total)/40000)*100, MIN_VALUE)
---

<BaseLayout
  title="Aidez Frustration Magazine à grandir !"
  displayBanner={false}>
  <PageLayout>
    <!-- 🅰️ Titles -->
    <TitlePullUp
      client:load
      words="Twitch, nouveaux formats et international : 40 000€ pour nous aider"
      className="text-5xl text-black lg:text-7xl text-pretty text-center font-bold uppercase font-bebas"
    />
    <ProgressBar
      client:load
      value={progressInPercent}
      delayInSeconds={2}
      background="bg-yellow"
      className="h-10 mt-12 shadow-lg"
    />
    <!-- 🔠 Text -->
    <article class="mt-12 px-2 font-open-sans tracking-wide text-lg">
      <p class="text-center mb-11 text-xl">
        Frustration magazine c’est un média en ligne <b>100% gratuit</b>, <b
          >100% indépendant</b
        >, <b>sans publicité ni mécène</b>, qui défend une <b
          >ligne radicale mais accessible</b
        >. C’est aussi une revue papier annuelle disponible dans toutes les
        bonnes librairies.
      </p>
      <h3 class="font-bold text-center text-2xl mb-6">
        Grâce à vous en une seule année nous avons :
      </h3>
      <ul
        class="text-base pl-6 xl:text-xl list-disc list-achievements space-y-4">
        <li>
          Produit de très nombreuses analyses, enquêtes et argumentaires pour
          mettre au jour la <b>réalité de la lutte des classes</b>, de la <b
            >domination coloniale</b
          > et des <b>mécanismes patriarcaux</b> ;
        </li>
        <li>
          Développé de <b>nouveaux formats vidéos</b> (<i>Comprendre</i>, <i
            >État des lieux</i
          >, <i>Frustration Rencontres</i> etc.) ;
        </li>
        <li>
          Rénové entièrement <b>nos réseaux sociaux</b> et tous nos <b
            >canaux de diffusion</b
          > pour les rendre plus agréables et lisibles ;
        </li>
        <li>
          Renforcé nos liens avec de <b>nombreux médias indépendants alliés</b> (partenariat
          avec <i>Le Média</i> pour l'émission <i>Coup de Griffe</i> par exemple)
          ;
        </li>
        <li>
          Envoyé des membres de notre équipe parler de la fin du capitalisme <b
            >dans des médias <i>mainstream</i></b
          > ;
        </li>
      </ul>
      <h3 class="font-bold text-center text-2xl mt-16 mb-6">
        Et cela a payé ! Puisque dans le même temps nous avons vu :
      </h3>
      <ul class="text-base pl-6 xl:text-xl list-disc space-y-4 list-results">
        <li>Le nombre de visiteurs sur notre site web multiplié par 2 ;</li>
        <li>Notre nombre d'abonnés sur Instagram et Youtube doubler ;</li>
        <li>Notre newsletter passer le cap des 6 000 abonnés ;</li>
        <li>Notre audience se rajeunir et se féminiser.</li>
      </ul>
      <h3 class="font-bold text-center text-2xl mt-16 mb-6">
        Fort de ces succès et actions, nous souhaitons continuer de nous
        développer en menant, en 2025, ces nouveaux projets :
      </h3>
      <ul class="text-base pl-6 xl:text-xl list-disc space-y-4 list-projects">
        <li>
          Une refonte complète de notre site web qui intègrera <b
            >des contenus interactifs</b
          >
          pour faire découvrir nos analyses comme des quiz, des contenus audios et
          vidéos inédits, notre horoscope décalé etc. ;
        </li>
        <li>
          <b>Agrandir encore notre équipe permanente</b> et accueillir <b
            >une plus grande diversité d'autrices et d'auteurs</b
          > pour couvrir encore plus de sujets qui nous tiennent à cœur ;
        </li>
        <li>
          <b>Accélérer le mouvement d'internationalisation </b>de notre travail
          avec nos partenaires belges, britanniques et espagnols ;
        </li>
        <li>
          Lancer une <b
            >émission régulière de commentaire d'actualité sur Twitch</b
          >
          ;
        </li>
        <li>Offrir un <b>toilettage complet</b> à Rob Grams.</li>
      </ul>
    </article>
    <TitlePullUp
      words="Twitch, nouveaux formats et international : 40 000€ pour nous aider"
      class="text-5xl text-black lg:text-7xl text-pretty text-center font-bold uppercase font-bebas"
    />
    <section class="mt-16 text-2xl text-center space-y-2">
      <p>
        Pour mener à bien ces projets, nous souhaitons <b
          >récolter 40 000 euros en trois mois</b
        >.
      </p>
      <p>
        Vous aimez notre travail, vous voulez nous aider à en faire plus ?
        <b>Vous pouvez donner la somme de votre choix !</b> Même les plus petits
        montants sont utiles.
      </p>
    </section>
    <CheckoutFormWrapper client:only="react" />
  </PageLayout>
</BaseLayout>
<style>
  @counter-style results-counter {
    system: cyclic;
    symbols: "✌️" "📈" "📨" "👩‍🎤";
    suffix: "  ";
  }

  @counter-style achievements-counter {
    system: cyclic;
    symbols: "🖋️" "🎥" "#️⃣" "🤝" "🧛" "🗯️" "🙅‍♂️" "👊";
    suffix: "  ";
  }

  @counter-style projects-counter {
    system: cyclic;
    symbols: "🎨" "👯" "🌍" "🎤" "🐶";
    suffix: "  ";
  }

  .list-achievements {
    list-style: achievements-counter;
  }

  .list-results {
    list-style: results-counter;
  }

  .list-projects {
    list-style: projects-counter;
  }
</style>
