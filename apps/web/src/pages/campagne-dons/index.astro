---
// üß± Components
import CheckoutFormWrapper from "./_components/CheckoutFormWrapper";
import ProgressBar from "./_components/ProgressBar";
import TitlePullUp from "./_components/TitlePullUp";
import Meteors from "./_components/Meteors";
import MarqueeDemo from "./_components/MarqueeDemo";
import { Image } from "astro:assets";

// üñºÔ∏è Layout
import BaseLayout from "@web/layout/BaseLayout/BaseLayout.astro";
import PageLayout from "@web/layout/PageLayout/PageLayout.astro";

// üîß Libs
import { stripe } from "@/data-access/stripe";
// import puppeteer from "puppeteer";

// üé® Assets

import TipeeeLogo from "./_assets/tipeee.png";
import SemaineType from "./_assets/semaine-type.jpg";
import CoverCampaign from "./_assets/cover-campaign.jpg";
import BottomPageIllu from "./_assets/bottom-page.webp";

// export const prerender = false;
Astro.response.headers.set(
  "Cache-Control",
  "s-maxage=3600, stale-while-revalidate",
);

let totalTipeee = 0;
let reviews: any = [];

// Tipeee comments and total
// const browser = await puppeteer.launch({
//   headless: true,
//   defaultViewport: null,
// });

// const page = await browser.newPage();

// await page.goto(
//   "https://fr.tipeee.com/aidez-nous-a-continuer-en-mieux/comments",
//   {
//     waitUntil: "domcontentloaded",
//   },
// );

// await page.waitForSelector(".p-comm-inner");

// const totalHandle = await page.$(
//   ".p-results-panel .p-result-item .p-value span",
// );
// if (totalHandle) {
//   totalTipeee = await totalHandle.evaluate((el: any) =>
//     el.textContent.trim()?.replace(/\s/g, "")?.match(/\d+/)?.at(0),
//   );
// }

// const reviewsHandle = await page.$$(".p-comm-inner");
// reviews = await Promise.all(
//   reviewsHandle.map(async (review) =>
//     review.evaluate((el) => {
//       const name = el?.querySelector(".p-c-author a")?.innerText;
//       const date = el
//         ?.querySelector(".p-c-metas")
//         ?.innerText.match(/\d+.+/)
//         .at(0);
//       const imgTag = el?.querySelector(".p-comm-heading a") as HTMLElement;

//       const img = getComputedStyle(imgTag)
//         .backgroundImage.match(/https[^"]*/)
//         ?.at(0);

//       const body = el?.querySelector(".p-c-content")?.innerText;

//       return { name, date, body, img };
//     }),
//   ),
// );

// Compute percent in progress for campaign
if (totalTipeee === 0) totalTipeee = 11141;

let transactions: any[] = [];
let has_more;
let next_page;
do {
  try {
    const resTransactions = (await stripe.charges.search({
      query: `metadata['campaign']:'dons-fin-2024' AND created>${new Date("2024-11-07").getTime() / 1000}`,
      limit: 100,
      ...(next_page ? { page: next_page } : {}),
    })) as any;
    next_page = resTransactions.next_page;
    has_more = resTransactions.has_more;
    if (has_more) next_page = resTransactions.next_page;
    transactions = [...transactions, ...resTransactions.data];
  } catch (e) {
    console.error("Error while fetching transactions for campaign", e);
  }
} while (has_more);
const totalSite = transactions.reduce((acc, cv) => acc + cv.amount / 100, 0);
const MIN_VALUE = 5;
const progressInPercent = Math.max(
  Math.floor(((totalSite + +totalTipeee) / 40000) * 100),
  MIN_VALUE,
);
---

<BaseLayout
  title="Aidez Frustration Magazine √† grandir !"
  displayBanner={false}>
  <PageLayout>
    <!-- üñºÔ∏è Cover -->
    <Image
      src={CoverCampaign}
      class="mx-auto mb-16"
      width="800"
      alt="Une semaine type de publications sur <i>Frustration</i> Magazine pour notre prochain r√©organisation"
    />
    <div
      class="relative flex h-[200px] w-full flex-col items-center justify-center overflow-hidden bg-background">
      <Meteors
        client:load
        number={20}
      />
      <!-- üÖ∞Ô∏è Titles -->
      <TitlePullUp
        client:load
        words="On a besoin de vous pour continuer !"
        className="z-10 text-4xl md:text-5xl text-black lg:text-7xl text-pretty text-center font-bold uppercase font-bakbak"
      />
    </div>
    <!-- === Progress bar -->
    <ProgressBar
      client:load
      value={progressInPercent}
      delayInSeconds={2}
      background="bg-yellow"
      className="h-10 mt-12 shadow-lg"
    />
    <!-- üî† Text -->
    <article class="mt-12 font-open-sans tracking-wide md:text-lg">
      <p class="mb-11">
        <i>Frustration</i> a fait d‚Äô√©normes progr√®s cette ann√©e, <b
          >mais notre mod√®le √©conomique n‚Äôest plus viable sur le long terme</b
        >. Nous sommes une √©quipe de 2,5 personnes, sans local, et malgr√© notre
        succ√®s croissant, <b>la charge de travail d√©passe nos capacit√©s</b>.
        Pour continuer √† produire un journalisme libre et de qualit√©, <b
          >nous avons besoin de votre soutien pour publier quotidiennement</b
        >, d√©velopper notre partie vid√©o, et offrir une vraie s√©curit√© √† notre
        √©quipe. Votre aide est essentielle pour que <i><i>Frustration</i></i>
        <b>devienne un m√©dia stable tout en restant ind√©pendant</b>.
      </p>
      <section class="mb-10">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          Pour r√©sumer
        </h3>
        <ul class="space-y-3 pl-3 list-decimal">
          <li>
            <b><i>Frustration</i> a r√©alis√© de gros progr√®s</b> : doublement de la
            fr√©quentation du site, meilleure visibilit√© m√©diatique, forte progression
            sur les r√©seaux sociaux, augmentation de la production d'articles et
            de vid√©os, et une version papier ambitieuse.
          </li>
          <li>
            <b>Mais notre mod√®le √©conomique n‚Äôest plus viable</b> : une √©quipe de
            seulement 2,5 personnes avec peu de moyens et une charge de travail exponentielle.
          </li>
          <li>
            <b>Nos d√©fis quotidiens</b> : gestion des mails, r√©seaux sociaux, correction
            d‚Äôarticles, production vid√©o, comptabilit√©, logistique des dons, etc.
          </li>
        </ul>
      </section>
      <section class="mb-10">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          Nos objectifs √† court terme
        </h3>
        <ul class="space-y-3 pl-3 list-disc">
          <li>
            <b>Publier quotidiennement</b> pour rivaliser avec les m√©dias install√©s.
          </li>
          <li>
            <b>Devenir un vrai m√©dia vid√©o</b> avec des formats longs et r√©guliers,
            en plus de l‚Äô√©crit.
          </li>
          <li>
            <b>Assurer une s√©curit√© professionnelle</b> en passant de statuts pr√©caires
            √† une √©quipe de 3 salari√©s en CDI √† temps plein.
          </li>
        </ul>
      </section>
      <p class="text-center text-2xl">
        <b>Votre soutien est essentiel</b> : votre aide permet de renforcer notre
        ind√©pendance et d‚Äôassurer la p√©rennit√© du m√©dia sans publicit√© ni subventions.
      </p>

      <Image
        src={SemaineType}
        class="mx-auto my-8"
        width="800"
        alt="Une semaine type de publications sur <i>Frustration</i> Magazine pour notre prochain r√©organisation"
      />
      <h3
        class="title-to-underline w-fit mx-auto uppercase font-bakbak text-center font-bold text-6xl mb-10">
        Comment nous aider ?
      </h3>
      <p class="text-3xl text-center mb-8">En participant √† notre Tipeee</p>
      <a
        href="https://fr.tipeee.com/aidez-nous-a-continuer-en-mieux"
        target="_blank">
        <h3 class="text-center text-5xl text-pretty emoji-pendular">üëá</h3>
        <Image
          src={TipeeeLogo}
          class="mx-auto my-8"
          width="200"
          alt="Logo de la plateforme de finance participatif Tipeee"
        />
      </a>
      <MarqueeDemo
        client:load
        reviews={reviews}
      />
      <p
        class="font-bold my-16 text-4xl gap-2 text-center flex items-center justify-center">
        <svg
          width="32"
          height="32"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
          ><path
            fill="currentColor"
            d="M11 22V6.83L2 16v-2.83L13 2v15.17L22 8v2.83z"
          ></path></svg
        >
        <span>OU</span>
        <svg
          width="32"
          height="32"
          viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg"
          ><path
            fill="currentColor"
            d="M11 22V6.83L2 16v-2.83L13 2v15.17L22 8v2.83z"
          ></path></svg
        >
      </p>

      <CheckoutFormWrapper client:only="react" />

      <section class="mt-24">
        <h3
          id="projets"
          class="w-fit font-bold text-3xl mb-6">
          Notre situation et nos projets
        </h3>
        <div class="space-y-3">
          <p>
            Ces derniers mois, <i>Frustration</i> a r√©alis√© de <em
              >gros progr√®s</em
            > dans la diffusion de son travail : <em
              >doublement de la fr√©quentation du site</em
            >, invitations m√©dias beaucoup plus r√©guli√®res, tr√®s grosses
            progressions sur les r√©seaux sociaux, augmentation de la production
            d‚Äôarticles et de vid√©os, une version papier de plus en plus
            ambitieuse qui rencontre un certain succ√®s‚Ä¶ Nous sommes tr√®s fier-es
            de tout cela.
          </p>
          <p>
            Malheureusement, <i>Frustration</i> fait face √† de <em
              >tr√®s lourdes difficult√©s</em
            >
            et √† un <em>d√©calage de plus en plus fort</em> entre la charge de travail
            exponentielle que repr√©sente son succ√®s et la r√©alit√© mat√©rielle de notre
            m√©dia.
          </p>
          <p>
            Nous ne sommes que <em>2,5 en √©quivalent temps plein</em> et nous ne
            disposons d‚Äô<em>aucun local</em>. De l‚Äôext√©rieur on s‚Äôimagine
            parfois que l‚Äôessentiel du travail dans un m√©dia r√©side dans
            l‚Äô√©criture d‚Äôarticles, d‚Äôenqu√™tes et d‚Äôentretiens. Cela ne
            repr√©sente pourtant, dans les faits, qu‚Äôune <em
              >part infime du travail</em
            >.
          </p>
          <p>
            Avec cette √©quipe <em>extr√™mement r√©duite</em>, nous devons au
            quotidien :
            <em>g√©rer les mails des lecteurs</em>, g√©rer les nombreux <em
              >r√©seaux sociaux</em
            >
            (Facebook, Youtube, Twitter, Mastodon, Threads, TikTok, Instagram‚Ä¶) et
            cr√©er des visuels, faire la <em
              >relecture, la correction et la mise en page des articles</em
            >, g√©rer et refonder le site (qui n‚Äôest plus assez solide par
            rapport √† l‚Äôafflux de nouveaux internautes), r√©aliser des
            newsletters, faire la <em>comptabilit√©</em>, g√©rer les dons (les
            modules, les demandes de r√©siliation ou de modification, les
            centaines d‚Äôenvois postaux pour les cadeaux‚Ä¶), faire le <em
              >travail vid√©o</em
            > (captation ou r√©alisation, montage, √©talonnage, mixage‚Ä¶), r√©aliser
            des illustrations, travailler sur la <em
              >production du num√©ro annuel</em
            > (recrutement, maquettage, relectures, tourn√©e promotionnelle qui implique
            de co-organiser des √©v√®nements‚Ä¶)...
          </p>
          <p>
            Vous le voyez s√ªrement en filigrane, en plus du paiement de la
            charge de travail, ces activit√©s ont un <em>co√ªt</em> : logiciels, d√©placements,
            mat√©riel vid√©o (cam√©ra, micro, logiciels de montage‚Ä¶), h√©bergement du
            site et divers plugins, frais postaux, mat√©riel informatique, outil de
            newsletter‚Ä¶ Nous sommes d‚Äôailleurs encore souvent contraintes et contraints
            d‚Äôassumer personnellement une partie de ces <em>co√ªts</em>.
          </p>
          <p>
            M√™me avec toute notre bonne volont√©, nous sommes face √† des <em
              >limites et des obstacles</em
            > qui nous emp√™chent de devenir le m√©dia solide, r√©gulier, serein que
            nous aimerions √™tre, que beaucoup de nos lectrices et lecteurs aimeraient
            que nous soyons (ou pensent que nous sommes d√©j√† en raison de l‚Äôoptimisme
            que nous souhaitons continuer √† afficher).
          </p>

          <p>
            C‚Äôest pourquoi nous vous sollicitons pour un <em>coup de pouce</em>.
            Notre
            <em>ind√©pendance</em>, la <em>gratuit√© totale</em> de notre site web,
            notre
            <em>refus de la publicit√©</em>, de l‚Äôargent des millionnaires
            (contrairement √† ce qu‚Äôon s‚Äôimagine : des m√©dias de gauche y font
            aussi parfois appel) et des subventions, tout cela n‚Äôest possible
            qu‚Äôavec votre <em>soutien</em>. Nous fonctionnons avec un mod√®le de
            dons mensuels pour avoir une base fiable chaque mois, que nous
            renfor√ßons avec des appels √† dons uniques pour celles et ceux qui ne
            peuvent pas donner de mani√®re aussi r√©guli√®re mais dont l‚Äôaide nous
            est aussi pr√©cieuse.
          </p>

          <p>
            La vente du magazine papier permet de rembourser sa production et
            peut parfois rapporter un peu d‚Äôexc√©dents - qui sont r√©inject√©s dans
            les d√©penses de fonctionnement du m√©dia - mais cela est tout √† fait
            <em>marginal</em> (moins de 3% des revenus).
          </p>

          <p>
            C‚Äôest donc un <em>mod√®le de financement original</em> qui repose enti√®rement
            sur la <em>confiance r√©ciproque</em> entre notre m√©dia, ses lectrices
            et ses lecteurs.
          </p>
        </div>
      </section>
      <section class="mt-12">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          √âtape n¬∞1 : Publier quotidiennement
        </h3>

        <div class="space-y-3">
          <p>
            Notre premier objectif est d‚Äôarriver √† <em
              >publier tous les jours</em
            >, comme le font les m√©dias plus install√©s. Vous le comprenez
            ais√©ment : avec toutes les t√¢ches que nous assurons avec une √©quipe
            tr√®s r√©duite et des moyens financiers faibles, nous ne sommes pas en
            mesure d‚Äô√©crire autant que nous le voudrions.
          </p>

          <p>
            Avec votre aide, nous pourrions <em
              >fid√©liser les contributeurs et contributrices</em
            > qui √©crivent d√©j√† pour <i>Frustration</i>, voire recourir
            davantage √† des
            <em>chroniques et des pigistes ext√©rieurs</em> (que nous souhaitons d‚Äôailleurs
            r√©mun√©rer d√©cemment contrairement √† des pratiques r√©pandues).
          </p>

          <p>
            En termes de contenus, cela nous permettrait √©galement d‚Äôavoir
            davantage de <em>formats d'enqu√™tes</em>, des articles qui, dans
            leur nature m√™me, sont beaucoup plus co√ªteux car impliquent des
            d√©placements, du mat√©riel‚Ä¶
          </p>
        </div>
      </section>
      <section class="mt-12">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          √âtape n¬∞2 : Devenir un vrai m√©dia (en plus de l'√©crit)
        </h3>

        <div class="space-y-5">
          <p>
            Une fois la production r√©guli√®re d‚Äôarticles consolid√©e, nous voulons
            poursuivre le d√©veloppement de notre <em>partie vid√©o</em>.
          </p>

          <p>
            Nous avons d√©j√† commenc√© √† le faire, avec un certain succ√®s, avec :

            <ul class="space-y-1 pl-3 list-disc">
              <li>
                Des captations d'√©v√©nements que nous avons organis√©s le
                d√©veloppement de trois s√©ries de formats vid√©o :
                <ul class="pl-5 space-y-2 mt-3">
                  <li>
                    <b>√âtat des lieux</b> - o√π des membres de l‚Äô√©quipe reviennent
                    sur l‚Äôactualit√© chaude du moment
                  </li>
                  <li>
                    <b>Comprendre</b> - un format plus documentaire et factuel qui
                    donne du contexte et de la profondeur sur un sujet en lien avec
                    l‚Äôactualit√©
                  </li>
                  <li>
                    <b>Rencontres</b> - un √©change entre un ou une membre de la r√©daction
                    et une ou un invit√©
                  </li>
                </ul>
              </li>
              <li>
                La publication plus r√©guli√®re de <em>reels</em> sur les r√©seaux sociaux
              </li>
              <li>
                La mise en place d‚Äôun <em>partenariat</em> avec <i>Le M√©dia</i> pour
                l‚Äô√©mission
                <i>Coup de Griffe</i>
              </li>
            </ul>
          </p>

          <p>
            Nous aimons l‚Äô√©criture et continuerons d‚Äô√™tre avant tout un m√©dia
            d‚Äôarticles √©crits. Toutefois la moindre vid√©o a un <em
              >audimat infiniment sup√©rieur</em
            > √† un article et c‚Äôest quelque chose que nous voulons prendre en compte
            par souci d‚Äô<em>accessibilit√© au plus grand nombre</em>. De la m√™me
            fa√ßon, une <em>cha√Æne Twitch</em> ne remplacerait pas notre travail de
            fond mais permettrait de s‚Äôadapter aux <em>nouveaux formats</em> et d‚Äôavoir
            davantage d‚Äô<em>interactions avec nos lectrices et lecteurs</em>,
            d‚Äôen faire un v√©ritable <em>espace d‚Äô√©changes</em>.
          </p>
        </div>
      </section>
      <section class="mt-12">
        <h3 class="title-to-highlight w-fit font-bold text-3xl mb-6">
          √âtape n¬∞3 : Offrir une vraie s√©curit√© professionnelle
        </h3>
        <div class="space-y-3">
          <p>
            Nous sommes <em>coh√©rentes et coh√©rents</em> : nous d√©fendons le droit
            √† des <em>bonnes conditions de travail</em> et √† des <em
              >salaires d√©cents</em
            >, c‚Äôest donc, naturellement, ce que nous voulons aussi offrir aux
            personnes qui travaillent pour notre magazine.
          </p>
          <p>
            C‚Äôest pourquoi nous souhaitons sortir du <em>statut pr√©caire</em>,
            fait notamment de <em>temps partiel</em>, dans lequel nous nous
            trouvons actuellement, pour avoir <em
              >trois salari√©s en CDI √† temps complet</em
            >, et si possible avec un <em
              >salaire autour du salaire moyen en France</em
            >.
          </p>
          <p>
            Avoir une <em>√©quipe de trois salari√©s √† temps complet</em> permettrait
            de <em>stabiliser √©norm√©ment le travail</em> au sein de <i
              >Frustration</i
            >.
          </p>
          <p>
            Voil√† donc les <em>objectifs que nous nous sommes fix√©s</em> et que nous
            avons voulus raisonnables et ce √† quoi, concr√®tement, votre aide contribuera.
          </p>
          <p>
            Nous vous <em>remer√ßions infiniment</em> pour votre <em
              >soutien pr√©cieux</em
            > depuis des ann√©es qui donne du <em>courage</em>, de l‚Äô<em
              >espoir</em
            > et de la <em>motivation</em> !
          </p>
        </div>
      </section>
    </article>
    <Image
      src={BottomPageIllu}
      class="mx-auto mt-12 -mb-16"
      width="800"
      alt="Une rang√©e de travailleuses et travailleurs"
    />
  </PageLayout>

  <script>
    import { annotate } from "rough-notation";
    const titlesToHighlight = Array.from(
      document.querySelectorAll(".title-to-highlight"),
    ) as HTMLElement[];

    titlesToHighlight.forEach((title) => {
      const annotation = annotate(title, {
        type: "highlight",
        animationDuration: 2000,
        color: "#FFF200",
      });
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              setTimeout(() => {
                annotation.show();
                observer.disconnect();
              }, 1000);
            }
          });
        },
        { threshold: 0.1 },
      );
      observer.observe(title);
    });

    const titlesToUnderline = Array.from(
      document.querySelectorAll(".title-to-underline"),
    ) as HTMLElement[];

    titlesToUnderline.forEach((title) => {
      const annotation = annotate(title, {
        type: "underline",
        iterations: 3,
        strokeWidth: 3,
        animationDuration: 2000,
        color: "black",
      });
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              setTimeout(() => {
                annotation.show();
                observer.disconnect();
              }, 1000);
            }
          });
        },
        { threshold: 0.1 },
      );
      observer.observe(title);
    });
  </script>
  <style>
    @counter-style results-counter {
      system: cyclic;
      symbols: "‚úåÔ∏è" "üìà" "üì®" "üë©‚Äçüé§";
      suffix: "  ";
    }

    @counter-style achievements-counter {
      system: cyclic;
      symbols: "üñãÔ∏è" "üé•" "#Ô∏è‚É£" "ü§ù" "üßõ" "üóØÔ∏è" "üôÖ‚Äç‚ôÇÔ∏è" "üëä";
      suffix: "  ";
    }

    @counter-style projects-counter {
      system: cyclic;
      symbols: "üé®" "üëØ" "üåç" "üé§" "üê∂";
      suffix: "  ";
    }
    @keyframes pendular {
      0%,
      100% {
        transform: translateY(0);
      }
      50% {
        transform: translateY(-10px);
      }
    }

    em {
      font-weight: bold;
      font-style: normal;
    }

    .emoji-pendular {
      animation: pendular 2s ease-in-out infinite;
    }

    .list-achievements {
      list-style: achievements-counter;
    }

    .list-results {
      list-style: results-counter;
    }

    .list-projects {
      list-style: projects-counter;
    }
  </style>
</BaseLayout>
